@model IEnumerable<Quizzical.QuizSession>

@{
    ViewBag.Title = "Quiz Sessions";
}

<h2>@ViewBag.Title</h2>

<p>
    @Html.ActionLink("Create New", "Create")
</p>
<table id="quizSessions" class="table">
    <tr>
        <th>
            @Html.DisplayNameFor(model => model.Quiz.Name)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.CurrentQuestionId)
        </th>
        <th></th>
    </tr>

    @foreach (var item in Model)
    {
        <tr data-quiz-id="@item.QuizId" data-session-id="@item.Id">
            <td>
                @Html.DisplayFor(modelItem => item.Quiz.Name)
            </td>
            <td>
                @Html.DropDownListFor(modelItem => item.CurrentQuestionId,
                                        new SelectList(new string[0]),
                                        "-- Select --",
                                        new { data_question_id = item.CurrentQuestionId })
            </td>


            <td>
                @Html.ActionLink("Edit", "Edit", new { id = item.Id }) |
                @Html.ActionLink("Details", "Details", new { id = item.Id }) |
                @Html.ActionLink("Delete", "Delete", new { id = item.Id })
            </td>
        </tr>
    }

</table>

@section scripts
{
    <script type="text/javascript">
        $(function () {

            $('#quizSessions').on('change', function(evt, el) {
                var sessionEl = $(evt.target).parents('tr'),
                    sessionId = sessionEl.data('session-id'),
                    request = {
                        quizId: sessionEl.data('quiz-id'),
                        currentQuestionId: $(evt.target).val()
                    };

                $.ajax({
                    url: '@Url.Action("Edit", "QuizSessions", new { area="Admin"})/' + sessionId,
                    type: "POST",
                    dataType: 'json',
                    data: JSON.stringify(request),
                    async: false,
                    cache: false,
                    traditional: true,
                    contentType: 'application/json',
                });
            });

            $('[name="item.CurrentQuestionId"]').each(function () {
                var dropdown = $(this),
                    currentQuestionId = dropdown.data('question-id'),
                    quizId = dropdown.parents('tr').data('quiz-id');

                $.ajax(['/api/quizzes', quizId, 'questions'].join('/')).then(function(questions) {

                    questions.forEach(function (question) {
                        dropdown.append($("<option />").val(question.id).text(question.id));
                    });

                    dropdown.val(currentQuestionId);
                });
            });
        })
    </script>
}
